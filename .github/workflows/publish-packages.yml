name: Publish Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
          - goos: darwin
            goarch: arm64  # Can add later if needed
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Get version from tag
        id: get_version
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Get version from input
        id: get_version_input
        if: github.event_name == 'workflow_dispatch'
        run: echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
      
      - name: Set version
        id: version
        run: |
          if [ "${{ steps.get_version.outputs.VERSION }}" != "" ]; then
            echo "VERSION=${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${{ steps.get_version_input.outputs.VERSION }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          BINARY_NAME="shelldock"
          if [ "${{ matrix.goos }}" == "windows" ]; then
            BINARY_NAME="shelldock.exe"
          fi
          go build -ldflags "-X main.version=${{ steps.version.outputs.VERSION }}" \
            -o build/shelldock-${{ matrix.goos }}-${{ matrix.goarch }}$([ "${{ matrix.goos }}" == "windows" ] && echo ".exe" || echo "") .
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v3
        with:
          name: binary-${{ matrix.goos }}-${{ matrix.goarch }}
          path: build/shelldock-${{ matrix.goos }}-${{ matrix.goarch }}$([ "${{ matrix.goos }}" == "windows" ] && echo ".exe" || echo "")
          retention-days: 90

  build-deb:
    needs: build-packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Download Linux amd64 binary
        uses: actions/download-artifact@v3
        with:
          name: binary-linux-amd64
          path: build/
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev debhelper
      
      - name: Create Debian package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARCH="amd64"
          mkdir -p dist/deb/DEBIAN
          mkdir -p dist/deb/usr/local/bin
          mkdir -p dist/deb/usr/share/doc/shelldock
          
          cp build/shelldock-linux-amd64 dist/deb/usr/local/bin/shelldock
          chmod +x dist/deb/usr/local/bin/shelldock
          cp README.md dist/deb/usr/share/doc/shelldock/
          
          sed "s/VERSION/$VERSION/g" packaging/deb/control > dist/deb/DEBIAN/control
          sed -i "s/Architecture: amd64/Architecture: $ARCH/g" dist/deb/DEBIAN/control
          
          if [ -f packaging/deb/postinst ]; then
            cp packaging/deb/postinst dist/deb/DEBIAN/postinst
            chmod +x dist/deb/DEBIAN/postinst
          fi
          
          dpkg-deb --build dist/deb dist/shelldock_${VERSION}_${ARCH}.deb
          echo "✅ Debian package created: dist/shelldock_${VERSION}_${ARCH}.deb"
      
      - name: Create Debian repository structure
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p repo/deb/pool/main/s/shelldock
          cp dist/shelldock_${VERSION}_amd64.deb repo/deb/pool/main/s/shelldock/
          
          # Create repository metadata
          cd repo/deb
          mkdir -p dists/stable/main/binary-amd64
          
          # Generate Packages file
          dpkg-scanpackages --multiversion pool/ > dists/stable/main/binary-amd64/Packages
          gzip -k dists/stable/main/binary-amd64/Packages
          
          # Create Release file
          cat > dists/stable/Release << EOF
          Origin: ShellDock
          Label: ShellDock Repository
          Suite: stable
          Codename: stable
          Version: $VERSION
          Architectures: amd64
          Components: main
          Description: ShellDock package repository
          EOF
          
          # Generate Release.gpg (would need GPG key in production)
          apt-ftparchive release dists/stable/ > dists/stable/Release
      
      - name: Upload Debian package
        uses: actions/upload-artifact@v3
        with:
          name: deb-package
          path: dist/*.deb
      
      - name: Upload Debian repository
        uses: actions/upload-artifact@v3
        with:
          name: deb-repo
          path: repo/deb/

  build-rpm:
    needs: build-packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Download Linux amd64 binary
        uses: actions/download-artifact@v3
        with:
          name: binary-linux-amd64
          path: build/
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm rpmbuild
      
      - name: Create RPM package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p dist/rpm/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          
          cp build/shelldock-linux-amd64 dist/rpm/SOURCES/shelldock
          sed "s/VERSION/$VERSION/g" packaging/rpm/shelldock.spec > dist/rpm/SPECS/shelldock.spec
          
          rpmbuild --define "_topdir $(pwd)/dist/rpm" \
                   --define "_version $VERSION" \
                   -bb dist/rpm/SPECS/shelldock.spec
          
          echo "✅ RPM package created"
      
      - name: Create RPM repository structure
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p repo/rpm
          
          # Copy RPM files
          find dist/rpm/RPMS -name "*.rpm" -exec cp {} repo/rpm/ \;
          
          # Create repository metadata
          cd repo/rpm
          createrepo .
          echo "✅ RPM repository created"
      
      - name: Upload RPM package
        uses: actions/upload-artifact@v3
        with:
          name: rpm-package
          path: dist/rpm/RPMS/**/*.rpm
      
      - name: Upload RPM repository
        uses: actions/upload-artifact@v3
        with:
          name: rpm-repo
          path: repo/rpm/

  build-arch:
    needs: build-packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Download Linux amd64 binary
        uses: actions/download-artifact@v3
        with:
          name: binary-linux-amd64
          path: build/
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot
      
      - name: Create Arch package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p dist/arch/{pkg,src}
          
          cp build/shelldock-linux-amd64 dist/arch/src/shelldock
          sed "s/VERSION/$VERSION/g" packaging/arch/PKGBUILD > dist/arch/PKGBUILD
          
          cd dist/arch
          makepkg --skipinteg -c
          echo "✅ Arch package created"
      
      - name: Upload Arch package
        uses: actions/upload-artifact@v3
        with:
          name: arch-package
          path: dist/arch/*.pkg.tar.zst

  create-release:
    needs: [build-deb, build-rpm, build-arch]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all packages
        uses: actions/download-artifact@v3
        with:
          path: packages/
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/**/*.deb
            packages/**/*.rpm
            packages/**/*.pkg.tar.zst
          body: |
            ## ShellDock ${{ steps.version.outputs.VERSION }}
            
            ### Installation
            
            #### Debian/Ubuntu (apt)
            ```bash
            curl -fsSL https://raw.githubusercontent.com/shelldock/shelldock/main/scripts/install-apt.sh | bash
            sudo apt update
            sudo apt install shelldock
            ```
            
            #### RedHat/CentOS/Fedora (yum/dnf)
            ```bash
            curl -fsSL https://raw.githubusercontent.com/shelldock/shelldock/main/scripts/install-yum.sh | bash
            sudo yum install shelldock
            ```
            
            #### Arch Linux
            ```bash
            curl -fsSL https://raw.githubusercontent.com/shelldock/shelldock/main/scripts/install-arch.sh | bash
            ```
            
            ### Manual Installation
            Download the appropriate package from the assets below.
          draft: false
          prerelease: false



