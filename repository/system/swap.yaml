name: swap
description: Swap file setup and configuration
versions:
  - version: "v1"
    latest: true
    description: Create and configure swap file
    commands:
      - description: Check current swap usage
        command: free -h
        skip_on_error: true
      - description: Check if swap file already exists
        platforms:
          ubuntu: test -f /swapfile && echo "Swap file exists" || echo "Swap file does not exist"
          debian: test -f /swapfile && echo "Swap file exists" || echo "Swap file does not exist"
          centos: test -f /swapfile && echo "Swap file exists" || echo "Swap file does not exist"
          rhel: test -f /swapfile && echo "Swap file exists" || echo "Swap file does not exist"
          fedora: test -f /swapfile && echo "Swap file exists" || echo "Swap file does not exist"
          arch: test -f /swapfile && echo "Swap file exists" || echo "Swap file does not exist"
          alpine: test -f /swapfile && echo "Swap file exists" || echo "Swap file does not exist"
        command: test -f /swapfile && echo "Swap file exists" || echo "Swap file does not exist"
        skip_on_error: true
      - description: Create swap file (2GB default) - skips if already exists
        platforms:
          ubuntu: 'if [ ! -f /swapfile ]; then sudo fallocate -l {{size}} /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count={{count}}; else echo "Swap file already exists, skipping creation"; fi'
          debian: 'if [ ! -f /swapfile ]; then sudo fallocate -l {{size}} /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count={{count}}; else echo "Swap file already exists, skipping creation"; fi'
          centos: 'if [ ! -f /swapfile ]; then sudo fallocate -l {{size}} /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count={{count}}; else echo "Swap file already exists, skipping creation"; fi'
          rhel: 'if [ ! -f /swapfile ]; then sudo fallocate -l {{size}} /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count={{count}}; else echo "Swap file already exists, skipping creation"; fi'
          fedora: 'if [ ! -f /swapfile ]; then sudo fallocate -l {{size}} /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count={{count}}; else echo "Swap file already exists, skipping creation"; fi'
          arch: 'if [ ! -f /swapfile ]; then sudo fallocate -l {{size}} /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count={{count}}; else echo "Swap file already exists, skipping creation"; fi'
          alpine: 'if [ ! -f /swapfile ]; then sudo dd if=/dev/zero of=/swapfile bs=1M count={{count}}; else echo "Swap file already exists, skipping creation"; fi'
        command: 'if [ ! -f /swapfile ]; then sudo fallocate -l {{size}} /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count={{count}}; else echo "Swap file already exists, skipping creation"; fi'
        args:
          - name: size
            prompt: "Enter swap file size (e.g., 2G, 4G, 512M)"
            default: "2G"
            required: false
          - name: count
            prompt: "Enter swap size in MB (fallback if fallocate fails, e.g., 2048 for 2GB)"
            default: "2048"
            required: false
        skip_on_error: true
      - description: Set secure permissions on swap file
        platforms:
          ubuntu: sudo chmod 600 /swapfile
          debian: sudo chmod 600 /swapfile
          centos: sudo chmod 600 /swapfile
          rhel: sudo chmod 600 /swapfile
          fedora: sudo chmod 600 /swapfile
          arch: sudo chmod 600 /swapfile
          alpine: sudo chmod 600 /swapfile
        command: sudo chmod 600 /swapfile
        skip_on_error: false
      - description: Format file as swap (skips if already formatted)
        platforms:
          ubuntu: 'if ! file /swapfile | grep -q "swap"; then sudo mkswap /swapfile; else echo "Swap file already formatted, skipping"; fi'
          debian: 'if ! file /swapfile | grep -q "swap"; then sudo mkswap /swapfile; else echo "Swap file already formatted, skipping"; fi'
          centos: 'if ! file /swapfile | grep -q "swap"; then sudo mkswap /swapfile; else echo "Swap file already formatted, skipping"; fi'
          rhel: 'if ! file /swapfile | grep -q "swap"; then sudo mkswap /swapfile; else echo "Swap file already formatted, skipping"; fi'
          fedora: 'if ! file /swapfile | grep -q "swap"; then sudo mkswap /swapfile; else echo "Swap file already formatted, skipping"; fi'
          arch: 'if ! file /swapfile | grep -q "swap"; then sudo mkswap /swapfile; else echo "Swap file already formatted, skipping"; fi'
          alpine: 'if ! file /swapfile | grep -q "swap"; then sudo mkswap /swapfile; else echo "Swap file already formatted, skipping"; fi'
        command: 'if ! file /swapfile | grep -q "swap"; then sudo mkswap /swapfile; else echo "Swap file already formatted, skipping"; fi'
        skip_on_error: true
      - description: Enable swap file (skips if already active)
        platforms:
          ubuntu: 'if ! swapon --show | grep -q "/swapfile"; then sudo swapon /swapfile; else echo "Swap file already active, skipping"; fi'
          debian: 'if ! swapon --show | grep -q "/swapfile"; then sudo swapon /swapfile; else echo "Swap file already active, skipping"; fi'
          centos: 'if ! swapon --show | grep -q "/swapfile"; then sudo swapon /swapfile; else echo "Swap file already active, skipping"; fi'
          rhel: 'if ! swapon --show | grep -q "/swapfile"; then sudo swapon /swapfile; else echo "Swap file already active, skipping"; fi'
          fedora: 'if ! swapon --show | grep -q "/swapfile"; then sudo swapon /swapfile; else echo "Swap file already active, skipping"; fi'
          arch: 'if ! swapon --show | grep -q "/swapfile"; then sudo swapon /swapfile; else echo "Swap file already active, skipping"; fi'
          alpine: 'if ! swapon --show | grep -q "/swapfile"; then sudo swapon /swapfile; else echo "Swap file already active, skipping"; fi'
        command: 'if ! swapon --show | grep -q "/swapfile"; then sudo swapon /swapfile; else echo "Swap file already active, skipping"; fi'
        skip_on_error: true
      - description: Verify swap is active
        platforms:
          ubuntu: free -h
          debian: free -h
          centos: free -h
          rhel: free -h
          fedora: free -h
          arch: free -h
          alpine: free -h
        command: free -h
        skip_on_error: true
      - description: Make swap permanent (add to /etc/fstab) - skips if already present
        platforms:
          ubuntu: 'if ! grep -q "/swapfile" /etc/fstab; then echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab; else echo "Swap file already in /etc/fstab, skipping"; fi'
          debian: 'if ! grep -q "/swapfile" /etc/fstab; then echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab; else echo "Swap file already in /etc/fstab, skipping"; fi'
          centos: 'if ! grep -q "/swapfile" /etc/fstab; then echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab; else echo "Swap file already in /etc/fstab, skipping"; fi'
          rhel: 'if ! grep -q "/swapfile" /etc/fstab; then echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab; else echo "Swap file already in /etc/fstab, skipping"; fi'
          fedora: 'if ! grep -q "/swapfile" /etc/fstab; then echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab; else echo "Swap file already in /etc/fstab, skipping"; fi'
          arch: 'if ! grep -q "/swapfile" /etc/fstab; then echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab; else echo "Swap file already in /etc/fstab, skipping"; fi'
          alpine: 'if ! grep -q "/swapfile" /etc/fstab; then echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab; else echo "Swap file already in /etc/fstab, skipping"; fi'
        command: 'if ! grep -q "/swapfile" /etc/fstab; then echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab; else echo "Swap file already in /etc/fstab, skipping"; fi'
        skip_on_error: true
      - description: Set swappiness (optional, default 60)
        platforms:
          ubuntu: 'echo "vm.swappiness={{swappiness}}" | sudo tee -a /etc/sysctl.conf && sudo sysctl vm.swappiness={{swappiness}}'
          debian: 'echo "vm.swappiness={{swappiness}}" | sudo tee -a /etc/sysctl.conf && sudo sysctl vm.swappiness={{swappiness}}'
          centos: 'echo "vm.swappiness={{swappiness}}" | sudo tee -a /etc/sysctl.conf && sudo sysctl vm.swappiness={{swappiness}}'
          rhel: 'echo "vm.swappiness={{swappiness}}" | sudo tee -a /etc/sysctl.conf && sudo sysctl vm.swappiness={{swappiness}}'
          fedora: 'echo "vm.swappiness={{swappiness}}" | sudo tee -a /etc/sysctl.conf && sudo sysctl vm.swappiness={{swappiness}}'
          arch: 'echo "vm.swappiness={{swappiness}}" | sudo tee -a /etc/sysctl.conf && sudo sysctl vm.swappiness={{swappiness}}'
          alpine: 'echo "vm.swappiness={{swappiness}}" | sudo tee -a /etc/sysctl.conf && sudo sysctl vm.swappiness={{swappiness}}'
        command: 'echo "vm.swappiness={{swappiness}}" | sudo tee -a /etc/sysctl.conf && sudo sysctl vm.swappiness={{swappiness}}'
        args:
          - name: swappiness
            prompt: "Enter swappiness value (0-100, lower = less swap usage, default 60)"
            default: "60"
            required: false
        skip_on_error: true

